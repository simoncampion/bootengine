#!/bin/bash

set -e

UNIT_DIR="$1"

if cat /proc/cmdline | grep -qw "rd.clevis_unlock=network"; then
    mkdir -p "${UNIT_DIR}/clevis-unlock.service.d"

    cat >${UNIT_DIR}/clevis-unlock.service.d/network_dependency.conf <<EOF
    # Automatically generated by clevis-network-generator

    [Unit]
    Wants=systemd-networkd.service systemd-resolved.service network-online.target
    After=systemd-networkd.service systemd-resolved.service network-online.target
EOF
fi